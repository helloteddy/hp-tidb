<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 9.4.0 (460661)"/><meta name="altitude" content="39.74677658081055"/><meta name="author" content="雄"/><meta name="created" content="2020-08-16 13:31:41 +0000"/><meta name="latitude" content="22.56373596191406"/><meta name="longitude" content="113.9749580526915"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2020-08-16 14:44:43 +0000"/><title>tidb 编译</title></head><body><div>操作系统版本：CentOS Linux release 7.6.1810 (Core)</div><div><br/></div><div>tidb的组件包含：tidb-server、pd、tikv。所以要运行一个tidb需要编译三个组件。</div><div><br/></div><div>tidb-server和pd都是go语言，但是tikv是rust。</div><div><br/></div><div>需要安装go语言、rust语言的环境。</div><div><span style="font-size: unset;"><br/></span></div><div><span style="font-size: unset; color: unset; font-family: unset;">Go 语言环境安装</span></div><div>执行命令：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">yum install goland</span></div></div><div>安装完成后查看go 版本</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>[root@3 ~]# go version</div><div>go version go1.13.14 linux/amd64</div></div><div>设置环境变量</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>mkdir ~/workspace</div><div>echo 'export GOPATH="$HOME/workspace"' &gt;&gt; ~/.bashrc</div><div>source ~/.bashrc</div></div><div>设置go env</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>go env -w GOPROXY=https://goproxy.io,direct</div><div>go env -w GO111MODULE=on</div></div><div>查看设置后的go env</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>go env</div></div><div><br/></div><div>rust语言环境安装</div><div>先设置临时变量，加速安装</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>export RUSTUP_DIST_SERVER=https://mirrors.ustc.edu.cn/rust-static</div><div>export RUSTUP_UPDATE_ROOT=https://mirrors.ustc.edu.cn/rust-static/rustup</div></div><div>执行安装命令</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>curl https://sh.rustup.rs -sSf | sh</div></div><div>刷新环境变量</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>source $HOME/.cargo/env</div></div><div>检查cargo 、rust的安装</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>cargo —version</div><div>rustc --version</div></div><div>修改cargo 源</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>vi ~/.cargo/config</div></div><div>增加以下内容</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>[source.crates-io]</div><div>registry = "https://github.com/rust-lang/crates.io-index"</div><div>replace-with = 'ustc'</div><div>[source.ustc]</div><div>registry = "https://mirrors.ustc.edu.cn/crates.io-index"</div></div><div><br/></div><div>至此环境搭建完成。</div><div><br/></div><div>下面开始逐个编译组件。</div><div>编译pd</div><div>下载源代码</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">git clone </span>https://github.com/pingcap/pd.git</div></div><div>开始编译pd</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>make build</div></div><div><br/></div><div><br/></div><div>编译tidb</div><div>下载源代码</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>  git clone https://github.com/pingcap/tidb.git</div></div><div>开始编译tidb</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>make build</div></div><div><br/></div><div><br/></div><div>编译tikv</div><div>下载源代码</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>git clone https://github.com/tikv/tikv.git</div></div><div>编译tikv</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>make build</div></div><div>编译中间需要下载相关组件，特别慢，需要耐心</div><div><br/></div><div><br/></div><div><br/></div><div>启动组件</div><div><br/></div><div>pd组件启动命令</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>nohup bin/pd-server --name=pd1 --client-urls=http://127.0.0.1:2379 --peer-urls=http://127.0.0.1:2380 --data-dir=/Users/xiexiong/data/pd &gt; pd.log 2&gt;&amp;1 &amp;</div></div><div><br/></div><div>tikv 组件启动命令</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>nohup bin/tikv-server -C bin/tikv-config.toml --addr 127.0.0.1:20160 --advertise-addr 127.0.0.1:20160 --pd 127.0.0.1:2379 --data-dir /Users/xiexiong/data/tikv &gt; tikv.log 2&gt;&amp;1 &amp;</div></div><div>tikv-config.toml 参考<a href="https://github.com/tikv/tikv/blob/master/etc/config-template.toml">https://github.com/tikv/tikv/blob/master/etc/config-template.toml</a></div><div>启动多个实例时记得修改地址端口</div><div><br/></div><div>tidb组件启动</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>nohup bin/tidb-server -store tikv -path '127.0.0.1:2379/pd?cluster=1' -P 4001 --data-dir /Users/xiexiong/data/tidb &gt; tidb.log 2&gt;&amp;1 &amp;</div></div><div><br/></div><div>启动完成之后可以通过mysql 来访问tidb了</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>mysql -uroot -P4000</div></div><div><br/></div><div><br/></div><div><br/></div><div>作业：使得tidb每启动一个事物时都会输出：hello transaction</div><div><br/></div><div>需要修改的组件是tidb组件</div><div>参考文章<a href="https://pingcap.com/blog-cn/tidb-source-code-reading-3/">https://pingcap.com/blog-cn/tidb-source-code-reading-3/</a></div><ol><li><div>处理客户端传输过来的请求的是server/conn.go文件里面的各种handle方法<br/></div></li></ol><ol start="2"><li><div>跟踪方法会走到Session.go 的Execute方法中，进而走到ExecuteStmt方法中</div></li><li><div><span>阅读ExecuteStmt方法可以找到生成事物的方法PrepareTxnCtx方法</span></div></li><li><div>在方法中加入输出所需字符即完成</div></li></ol><div>修改部分代码如下：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>func (s *session) PrepareTxnCtx(ctx context.Context) {</div><div>   if s.txn.validOrPending() {</div><div>      return</div><div>   }</div><div>   log.Info("hello transaction")</div><div>   is := domain.GetDomain(s).InfoSchema()</div><div>   s.sessionVars.TxnCtx = &amp;variable.TransactionContext{</div><div>      InfoSchema:    is,</div><div>      SchemaVersion: is.SchemaMetaVersion(),</div><div>      CreateTime:    time.Now(),</div><div>      ShardStep:     int(s.sessionVars.ShardAllocateStep),</div><div>   }</div><div><span>    …. 省略</span><br/></div><div>}</div></div><div><br/></div><div>重新编译tidb代码，之后重新运行各个组件。可以在tidb.log查看对应的输出</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>[2020/08/16 22:43:49.913 +08:00] [INFO] [server.go:235] ["server is running MySQL protocol"] [addr=0.0.0.0:4000]</div><div>[2020/08/16 22:43:49.913 +08:00] [INFO] [http_status.go:82] ["for status and metrics report"] ["listening on addr"=0.0.0.0:10080]</div><div>[2020/08/16 22:43:49.913 +08:00] [INFO] [session.go:2169] ["hello transaction"]</div><div>[2020/08/16 22:43:49.915 +08:00] [INFO] [domain.go:1094] ["init stats info time"] ["take time"=2.157604ms]</div><div>[2020/08/16 22:43:52.913 +08:00] [INFO] [session.go:2169] ["hello transaction"]</div><div>[2020/08/16 22:43:52.913 +08:00] [INFO] [session.go:2169] ["hello transaction"]</div><div>[2020/08/16 22:43:52.913 +08:00] [INFO] [session.go:2169] ["hello transaction"]</div><div>[2020/08/16 22:43:52.914 +08:00] [INFO] [session.go:2169] ["hello transaction"]</div><div>[2020/08/16 22:43:55.910 +08:00] [INFO] [session.go:2169] ["hello transaction"]</div></div><div><br/></div><div><br/></div><div>任务完成</div><div><br/></div></body></html>